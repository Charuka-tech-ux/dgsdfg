<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Professional Invoice System</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --primary-light: #dbeafe;
        --secondary-color: #64748b;
        --danger-color: #dc2626;
        --danger-hover: #b91c1c;
        --success-color: #059669;
        --warning-color: #d97706;
        --text-dark: #1e293b;
        --text-medium: #475569;
        --text-light: #64748b;
        --surface-bg: #ffffff;
        --app-bg: #f8fafc;
        --border-color: #e2e8f0;
        --border-light: #f1f5f9;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --border-radius: 12px;
        --border-radius-sm: 8px;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        color: var(--text-dark);
        line-height: 1.6;
        min-height: 100vh;
    }

    .container {
        max-width: 1200px;
        margin: 1rem auto;
        background: var(--surface-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
        color: white;
        padding: 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
        0%, 100% { transform: rotate(0deg); }
        50% { transform: rotate(180deg); }
    }

    .header-content {
        position: relative;
        z-index: 1;
    }

    .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header p {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 300;
    }

    .main-content {
        padding: 2rem;
    }

    h2 {
        font-size: 1.75rem;
        margin-bottom: 1.5rem;
        color: var(--text-dark);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    h2::before {
        content: '';
        width: 4px;
        height: 24px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        border-radius: 2px;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-medium);
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    input, textarea, select {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius-sm);
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.2s ease;
        background: var(--surface-bg);
    }

    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        transform: translateY(-1px);
    }
    
    textarea {
        resize: vertical;
        min-height: 100px;
    }

    .dates-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    /* Services Table Styles */
    .table-container {
        background: var(--surface-bg);
        border-radius: var(--border-radius-sm);
        box-shadow: var(--shadow-sm);
        border: 2px solid var(--border-color);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

    .table-scroll {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .services-table {
        width: 100%;
        min-width: 700px;
        border-collapse: collapse;
        background: var(--surface-bg);
    }

    .services-table th {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
        padding: 1rem 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        white-space: nowrap;
    }

    .services-table th:nth-child(1) { width: 45%; }
    .services-table th:nth-child(2) { width: 12%; text-align: center; }
    .services-table th:nth-child(3) { width: 18%; text-align: right; }
    .services-table th:nth-child(4) { width: 18%; text-align: right; }
    .services-table th:nth-child(5) { width: 7%; text-align: center; }

    .services-table td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-light);
        vertical-align: middle;
    }

    .services-table tbody tr:hover {
        background: var(--app-bg);
    }

    .services-table input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.875rem;
        margin: 0;
        box-sizing: border-box;
    }

    .services-table input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        transform: none;
    }

    .services-table input[type="number"] {
        text-align: right;
    }

    .services-table .qty-input {
        text-align: center !important;
        max-width: 80px;
    }

    .line-total {
        font-weight: 600;
        color: var(--primary-color);
        text-align: right !important;
        padding-right: 1rem !important;
    }

    .btn {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
        border: none;
        padding: 0.875rem 1.5rem;
        border-radius: var(--border-radius-sm);
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 600;
        font-family: inherit;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        text-decoration: none;
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
        white-space: nowrap;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .btn:active {
        transform: translateY(0);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn:disabled:hover {
        transform: none;
        box-shadow: var(--shadow-sm);
    }
    
    .btn-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2rem;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .btn.danger { 
        background: linear-gradient(135deg, var(--danger-color), var(--danger-hover)); 
    }
    
    .btn.success { 
        background: linear-gradient(135deg, var(--success-color), #047857); 
    }

    .btn.warning { 
        background: linear-gradient(135deg, var(--warning-color), #b45309); 
    }

    .btn.small {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        min-width: 70px;
    }

    .page { 
        display: none; 
        animation: fadeIn 0.3s ease-in-out;
    }
    
    .page.active { 
        display: block; 
    }
    
    @keyframes fadeIn {
        from { 
            opacity: 0; 
            transform: translateY(20px); 
        }
        to { 
            opacity: 1; 
            transform: translateY(0); 
        }
    }

    .transaction-list {
        background: var(--app-bg);
        border-radius: var(--border-radius-sm);
        padding: 1.5rem;
        max-height: 400px;
        overflow-y: auto;
        border: 2px solid var(--border-color);
    }

    .transaction-item {
        background: var(--surface-bg);
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-radius: var(--border-radius-sm);
        border-left: 4px solid var(--success-color);
        box-shadow: var(--shadow-sm);
        transition: transform 0.2s ease;
        position: relative;
    }

    .transaction-item:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .transaction-item:last-child { 
        margin-bottom: 0; 
    }

    .transaction-item.refund {
        border-left-color: var(--danger-color);
    }

    .transaction-actions {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: flex;
        gap: 0.5rem;
    }

    .transaction-actions button {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .edit-btn {
        background: var(--warning-color);
        color: white;
    }

    .delete-btn {
        background: var(--danger-color);
        color: white;
    }

    .edit-btn:hover, .delete-btn:hover {
        transform: scale(1.05);
    }

    .totals { 
        background: linear-gradient(135deg, var(--app-bg), var(--surface-bg));
        padding: 1.5rem;
        border-radius: var(--border-radius-sm);
        margin-top: 1.5rem;
        border: 2px solid var(--border-color);
    }
    
    .totals p { 
        margin-bottom: 0.75rem; 
        font-size: 1.125rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .totals p:last-child {
        margin-bottom: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        padding-top: 0.75rem;
        border-top: 2px solid var(--border-color);
    }
    
    .preview-box {
        background: var(--surface-bg);
        border-radius: var(--border-radius-sm);
        margin-top: 1.5rem;
        border: 2px solid var(--border-color);
        max-height: 70vh; /* Re-set to prevent excessive content display on screen */
        overflow-y: auto;
        box-shadow: var(--shadow-md);
    }
    
    .error-message {
        color: var(--danger-color);
        font-size: 0.875rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: rgba(220, 38, 38, 0.1);
        border-radius: 4px;
        border-left: 4px solid var(--danger-color);
    }

    .tabs {
        display: flex;
        background: var(--app-bg);
        padding: 0.5rem;
        border-radius: var(--border-radius-sm);
        margin-bottom: 2rem;
        gap: 0.5rem;
        overflow-x: auto;
        position: relative;
    }

    .tab {
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius-sm);
        background: var(--surface-bg);
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        white-space: nowrap;
        color: var(--text-medium);
        border: 2px solid transparent;
        min-width: fit-content;
    }

    .tab:hover {
        background: var(--border-light);
        transform: translateY(-1px);
    }

    .tab.active {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
        border-color: var(--primary-hover);
        box-shadow: var(--shadow-md);
    }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
        body {
            background: var(--surface-bg);
        }

        .container {
            margin: 0;
            border-radius: 0;
            min-height: 100vh;
        }

        .header {
            padding: 1.5rem 1rem;
        }

        .header h1 {
            font-size: 1.875rem;
        }

        .main-content {
            padding: 1rem;
        }

        .form-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .dates-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .btn-group {
            flex-direction: column;
            gap: 0.75rem;
        }

        .btn-group .btn {
            width: 100%;
        }

        /* Mobile Services Table */
        .services-table {
            min-width: 600px;
            font-size: 0.875rem;
        }

        .services-table th, .services-table td {
            padding: 0.6rem 0.4rem;
        }

        .services-table input {
            padding: 0.4rem;
            font-size: 0.8rem;
        }

        .tabs {
            padding: 0.25rem;
        }

        .tab {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
        }

        h2 {
            font-size: 1.5rem;
        }

        .totals p {
            font-size: 1rem;
        }

        .totals p:last-child {
            font-size: 1.25rem;
        }

        .transaction-item {
            padding-right: 4rem;
            font-size: 0.9rem;
        }

        .transaction-actions {
            flex-direction: column;
            gap: 0.25rem;
        }

        .preview-box {
            max-height: 60vh;
        }
    }

    @media (max-width: 480px) {
        .form-grid {
            gap: 0.75rem;
        }

        input, textarea, select {
            padding: 0.75rem;
            font-size: 16px; /* Prevents zoom on iOS */
        }

        .btn {
            padding: 1rem;
            font-size: 0.875rem;
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .header p {
            font-size: 1rem;
        }

        /* Ultra Mobile Services Table */
        .services-table {
            min-width: 550px;
            font-size: 0.8rem;
        }

        .services-table th, .services-table td {
            padding: 0.5rem 0.3rem;
        }

        .services-table input {
            padding: 0.35rem;
            font-size: 0.75rem;
        }

        .transaction-item {
            font-size: 0.85rem;
            padding-right: 3.5rem;
        }

        .transaction-actions button {
            padding: 0.125rem 0.25rem;
            font-size: 0.625rem;
        }
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: var(--surface-bg);
        margin: 15% auto;
        padding: 2rem;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 500px;
        position: relative;
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-light);
        padding: 0.5rem;
        border-radius: 50%;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: var(--border-light);
        color: var(--text-dark);
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius-sm);
        color: white;
        font-weight: 600;
        z-index: 10000;
        animation: slideInNotification 0.3s ease;
    }

    .notification.success {
        background: var(--success-color);
    }

    .notification.error {
        background: var(--danger-color);
    }

    @keyframes slideInNotification {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* PDF Styles */
    .pdf-invoice {
        width: 210mm;
        padding: 15mm;
        margin: 0 auto;
        background: white;
        font-family: Arial, sans-serif;
        font-size: 11pt;
        line-height: 1.4;
        color: #333;
        box-sizing: border-box;
    }

    .invoice-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #2563eb;
    }

    .invoice-header .left {
        flex: 0 0 60%;
    }

    .invoice-header .right {
        flex: 0 0 40%;
        text-align: right;
    }

    .company-info h1 {
        color: #2563eb;
        font-size: 24pt;
        font-weight: bold;
        margin: 0 0 5px 0;
    }

    .company-details {
        font-size: 9pt;
        color: #666;
        line-height: 1.6;
    }

    .contact-info {
        margin-top: 8px;
    }

    .contact-row {
        margin-bottom: 3px;
    }

    .invoice-title h2 {
        font-size: 28pt;
        color: #2563eb;
        margin: 0;
        font-weight: bold;
    }

    .invoice-number {
        font-size: 11pt;
        margin-top: 5px;
        color: #666;
    }

    .billing-section {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .bill-to, .invoice-dates {
        width: 48%;
    }

    .section-title {
        color: #2563eb;
        font-size: 11pt;
        margin: 0 0 5px 0;
        text-transform: uppercase;
        font-weight: bold;
    }

    .client-name {
        font-size: 12pt;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .client-details {
        color: #666;
        font-size: 10pt;
        line-height: 1.4;
    }

    .services-section, .transactions-section {
        margin: 15px 0;
    }

    .pdf-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .pdf-table th, .pdf-table td {
        padding: 10px 8px;
        border: 1px solid #ddd;
        font-size: 10pt;
        text-align: left;
    }

    .pdf-table th {
        background-color: #f5f5f5;
        font-weight: bold;
        text-transform: uppercase;
        color: #555;
    }

    .pdf-table td:nth-child(2),
    .pdf-table th:nth-child(2),
    .pdf-table td:nth-child(3),
    .pdf-table th:nth-child(3),
    .pdf-table td:nth-child(4),
    .pdf-table th:nth-child(4) {
        text-align: right;
    }

    .totals-section {
        margin-top: 15px;
        text-align: right;
    }

    .totals-table {
        margin-left: auto;
        width: 250px;
        border-collapse: collapse;
    }

    .totals-table td {
        padding: 6px 12px;
        border-bottom: 1px solid #ddd;
        font-size: 10pt;
    }

    .totals-table td:first-child {
        text-align: right;
        color: #666;
    }

    .totals-table td:last-child {
        text-align: right;
        font-weight: bold;
    }

    .total-due {
        background-color: #2563eb !important;
        color: white !important;
    }

    .total-due td {
        border-bottom: none !important;
        font-size: 12pt !important;
        font-weight: bold !important;
        color: white !important;
    }

    .footer-section {
        margin-top: 25px;
        padding-top: 15px;
        border-top: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .thank-you {
        color: #2563eb;
        font-weight: bold;
        font-size: 12pt;
        text-align: right;
    }

</style>
</head>
<body>

<div class="container" id="invoiceArea">
  <div class="header">
    <div class="header-content">
      <h1>Professional Invoice System</h1>
      <p>Manikshan Foreign Employment</p>
    </div>
  </div>

  <div class="main-content">
    <div class="tabs">
      <div class="tab active" onclick="showPage('detailsPage', this)">Details</div>
      <div class="tab" onclick="showPage('servicesPage', this)">Services</div>
      <div class="tab" onclick="showPage('transactionsPage', this)">Transactions</div>
      <div class="tab" onclick="showPage('previewPage', this)">Preview</div>
    </div>

    <div class="page active" id="detailsPage">
      <h2>Client Information</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="invoiceNo">Invoice / File Number</label>
          <input type="text" id="invoiceNo" placeholder="e.g., INV-2025-001">
        </div>
        <div class="form-group">
          <label for="passport">Passport Number</label>
          <input type="text" id="passport" placeholder="e.g., N1234567">
        </div>
        <div class="form-group">
          <label for="fullName">Full Name</label>
          <input type="text" id="fullName" placeholder="e.g., John Doe">
        </div>
        <div class="form-group">
          <label for="contact">Contact Number</label>
          <input type="text" id="contact" placeholder="e.g., +94 77 123 4567">
        </div>
      </div>
      
      <div class="form-group">
        <label for="address">Complete Address</label>
        <textarea id="address" placeholder="Enter client's full address including city, postal code, and country"></textarea>
      </div>

      <h2>Important Dates & Amounts</h2>
      <div class="dates-grid">
        <div class="form-group">
          <label for="issuedDate">Issue Date</label>
          <input type="date" id="issuedDate">
        </div>
        <div class="form-group">
          <label for="dueDate">Due Date</label>
          <input type="date" id="dueDate">
        </div>
        <div class="form-group">
          <label for="paymentMade">Payment Made Date</label>
          <input type="date" id="paymentMade">
        </div>
        <div class="form-group">
          <label for="dueAmountField">Due Amount (LKR)</label>
          <input type="number" id="dueAmountField" placeholder="0.00" step="0.01" min="0">
        </div>
      </div>
      
      <div class="btn-group">
        <div></div>
        <button class="btn" onclick="showPage('servicesPage')">Continue to Services</button>
      </div>
    </div>

    <div class="page" id="servicesPage">
      <h2>Services & Products</h2>
      
      <div class="table-container">
        <div class="table-scroll">
          <table class="services-table">
            <thead>
              <tr>
                <th>Service Description</th>
                <th>Qty</th>
                <th>Price (LKR)</th>
                <th>Total (LKR)</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="servicesTableBody">
            </tbody>
          </table>
        </div>
      </div>
      
      <button class="btn success" onclick="addServiceRow()">Add New Service</button>
      
      <div class="totals">
        <p>Subtotal: <span id="subTotal">0.00 LKR</span></p>
        <p>Grand Total: <span id="grandTotal">0.00 LKR</span></p>
      </div>
      
      <div class="btn-group">
        <button class="btn" onclick="showPage('detailsPage')">Back to Details</button>
        <button class="btn" onclick="showPage('transactionsPage')">Continue to Transactions</button>
      </div>
    </div>

    <div class="page" id="transactionsPage">
      <h2>Record Payment Transaction</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="transDate">Transaction Date</label>
          <input type="date" id="transDate">
        </div>
        <div class="form-group">
          <label for="transAmount">Amount (LKR)</label>
          <input type="number" id="transAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label for="transType">Transaction Type</label>
          <select id="transType">
            <option value="Payment">Payment Received</option>
            <option value="Refund">Refund Issued</option>
          </select>
        </div>
        <div class="form-group">
          <label for="transMethod">Payment Method</label>
          <input list="methodOptions" id="transMethod" placeholder="e.g., Cash, Bank Transfer, Card">
          <datalist id="methodOptions">
            <option value="Cash Payment"></option>
            <option value="Credit/Debit Card"></option>
            <option value="Bank Transfer"></option>
            <option value="Online Payment"></option>
            <option value="Mobile Payment"></option>
          </datalist>
        </div>
      </div>
      
      <div id="transactionError" class="error-message" style="display: none;"></div>
      
      <button class="btn success" onclick="addTransaction()">Record Transaction</button>
      
      <h2>Transaction History</h2>
      <div class="transaction-list" id="transList">
        <div class="transaction-item" style="color: var(--text-light); text-align: center; border: 2px dashed var(--border-color); border-left: none;">
          No transactions recorded yet
        </div>
      </div>
      
      <div class="totals">
        <p>Total Paid: <span id="totalPaid">0.00 LKR</span></p>
        <p>Outstanding Balance: <span id="amountDue">0.00 LKR</span></p>
      </div>
      
      <div class="btn-group">
        <button class="btn" onclick="showPage('servicesPage')">Back to Services</button>
        <button class="btn" onclick="showPage('previewPage')">Generate Preview</button>
      </div>
    </div>

    <div class="page" id="previewPage">
      <h2>Invoice Preview & Download</h2>
      <div class="preview-box" id="previewContent">
        <div style="text-align: center; padding: 3rem; color: var(--text-light);">
          <h3>Invoice Preview</h3>
          <p>Your invoice preview will appear here</p>
        </div>
      </div>
      
      <div class="btn-group">
        <button class="btn" onclick="showPage('transactionsPage')">Back to Transactions</button>
        <button class="btn danger" id="downloadBtn" onclick="generatePDF()">Download PDF Invoice</button>
      </div>
    </div>

  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Transaction</h3>
      <button class="modal-close" onclick="closeEditModal()">&times;</button>
    </div>
    <div class="form-grid">
      <div class="form-group">
        <label for="editTransDate">Transaction Date</label>
        <input type="date" id="editTransDate">
      </div>
      <div class="form-group">
        <label for="editTransAmount">Amount (LKR)</label>
        <input type="number" id="editTransAmount" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="form-group">
        <label for="editTransType">Transaction Type</label>
        <select id="editTransType">
          <option value="Payment">Payment Received</option>
          <option value="Refund">Refund Issued</option>
        </select>
      </div>
      <div class="form-group">
        <label for="editTransMethod">Payment Method</label>
        <input list="methodOptions" id="editTransMethod" placeholder="e.g., Cash, Bank Transfer, Card">
      </div>
    </div>
    <div class="btn-group" style="margin-top: 1.5rem;">
      <button class="btn" onclick="closeEditModal()">Cancel</button>
      <button class="btn success" onclick="saveEditTransaction()">Save Changes</button>
    </div>
  </div>
</div>

<script>
// Global State
let transactions = [];
let editingTransactionIndex = -1;
const serviceOptions = [
    'Initial Zoom Consultation',
    'Initial Payment',
    'Third-Party Agent Interview',
    'Employer / Host Company Interview',
    'Final Payment / Visa Approval',
    'Document Processing',
    'Application Fee',
    'Service Charge'
];

// Initialize the form
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
});

function initializeForm() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('issuedDate').value = today;
    document.getElementById('transDate').value = today;
    
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];

    addServiceRow();
    renderTransactions();
    updateTotals();
}

// Navigation Functions
function showPage(pageId, tabElement = null) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    
    if (tabElement) {
        tabElement.classList.add('active');
    } else {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            if (tab.textContent.toLowerCase().includes(pageId.replace('Page', ''))) {
                tab.classList.add('active');
            }
        });
    }
    
    if (pageId === 'previewPage') {
        generatePreviewContent();
    }
    
    updateTotals();
}

// Services Management
function addServiceRow(desc = '', qty = 1, price = 0) {
    const tbody = document.getElementById('servicesTableBody');
    const row = document.createElement('tr');
    
    const serviceOptionsHTML = serviceOptions.map(option => `<option value="${option}"></option>`).join('');
    
    row.innerHTML = `
        <td>
            <input list="serviceOptions" value="${desc}" oninput="calculateTotals()" placeholder="Enter service description">
            <datalist id="serviceOptions">${serviceOptionsHTML}</datalist>
        </td>
        <td>
            <input type="number" class="qty-input" value="${qty}" min="1" step="1" oninput="calculateTotals()">
        </td>
        <td>
            <input type="number" value="${price.toFixed(2)}" min="0" step="0.01" oninput="calculateTotals()">
        </td>
        <td class="line-total">0.00</td>
        <td>
            <button class="btn danger small" onclick="removeServiceRow(this)">Remove</button>
        </td>
    `;
    
    tbody.appendChild(row);
    calculateTotals();
}

function removeServiceRow(button) {
    button.closest('tr').remove();
    calculateTotals();
}

function calculateTotals() {
    const rows = document.querySelectorAll('#servicesTableBody tr');
    let subtotal = 0;
    
    rows.forEach(row => {
        const qty = parseFloat(row.cells[1].querySelector('input').value) || 0;
        const price = parseFloat(row.cells[2].querySelector('input').value) || 0;
        const lineTotal = qty * price;
        row.cells[3].textContent = formatCurrency(lineTotal);
        subtotal += lineTotal;
    });
    
    document.getElementById('subTotal').textContent = formatCurrency(subtotal) + ' LKR';
    document.getElementById('grandTotal').textContent = formatCurrency(subtotal) + ' LKR';
    
    updateTotals();
}

function updateTotals() {
    const grandTotal = parseFloat(document.getElementById('grandTotal').textContent.replace(/ LKR|,/g, '')) || 0;
    
    const totalPaid = transactions
        .filter(t => t.type === 'Payment')
        .reduce((sum, t) => sum + t.amount, 0);
    const totalRefunded = transactions
        .filter(t => t.type === 'Refund')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const amountDue = grandTotal - totalPaid + totalRefunded;
    
    document.getElementById('totalPaid').textContent = formatCurrency(totalPaid) + ' LKR';
    // This 'amountDue' span is the "Outstanding Balance" on the transactions page, which should still calculate for user reference.
    document.getElementById('amountDue').textContent = formatCurrency(amountDue) + ' LKR';
    // The 'dueAmountField' on the details page is now fully manual and is NOT updated here.
}

// Transaction Management
function addTransaction() {
    const errorEl = document.getElementById('transactionError');
    const type = document.getElementById('transType').value;
    const method = document.getElementById('transMethod').value.trim();
    const date = document.getElementById('transDate').value;
    const amount = parseFloat(document.getElementById('transAmount').value) || 0;

    errorEl.style.display = 'none';
    
    if (!date || amount <= 0 || !method) {
        errorEl.textContent = 'Please fill in all transaction details with a valid amount greater than 0.';
        errorEl.style.display = 'block';
        return;
    }
    
    transactions.push({ type, method, date, amount });
    renderTransactions();
    updateTotals();
    
    document.getElementById('paymentMade').value = date;
    document.getElementById('transMethod').value = '';
    document.getElementById('transAmount').value = '';
    document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
    
    showNotification('Transaction recorded successfully!');
}

function renderTransactions() {
    const list = document.getElementById('transList');
    list.innerHTML = '';
    
    if (transactions.length === 0) {
        list.innerHTML = `<div class="transaction-item" style="color: var(--text-light); text-align: center; border: 2px dashed var(--border-color); border-left: none;">No transactions recorded yet</div>`;
        return;
    }
    
    transactions.forEach((transaction, index) => {
        const item = document.createElement('div');
        item.className = `transaction-item ${transaction.type.toLowerCase()}`;
        const sign = transaction.type === 'Payment' ? '' : '-';
        const color = transaction.type === 'Payment' ? 'var(--success-color)' : 'var(--danger-color)';
        
        item.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                <div style="flex: 1; min-width: 200px;">
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${transaction.type} via ${transaction.method}</div>
                    <div style="font-size: 0.875rem; color: var(--text-light);">${formatDate(transaction.date)}</div>
                </div>
                <div style="font-weight: 700; font-size: 1.125rem; color: ${color};">${sign} ${formatCurrency(transaction.amount)} LKR</div>
            </div>
            <div class="transaction-actions">
                <button class="edit-btn" onclick="editTransaction(${index})">Edit</button>
                <button class="delete-btn" onclick="deleteTransaction(${index})">Delete</button>
            </div>
        `;
        list.appendChild(item);
    });
}

function editTransaction(index) {
    editingTransactionIndex = index;
    const transaction = transactions[index];
    document.getElementById('editTransDate').value = transaction.date;
    document.getElementById('editTransAmount').value = transaction.amount.toFixed(2);
    document.getElementById('editTransType').value = transaction.type;
    document.getElementById('editTransMethod').value = transaction.method;
    document.getElementById('editModal').style.display = 'block';
}

function deleteTransaction(index) {
    if (confirm('Are you sure you want to delete this transaction?')) {
        transactions.splice(index, 1);
        renderTransactions();
        updateTotals();
        showNotification('Transaction deleted successfully!');
    }
}

function saveEditTransaction() {
    if (editingTransactionIndex === -1) return;
    
    const type = document.getElementById('editTransType').value;
    const method = document.getElementById('editTransMethod').value.trim();
    const date = document.getElementById('editTransDate').value;
    const amount = parseFloat(document.getElementById('editTransAmount').value) || 0;
    
    if (!date || amount <= 0 || !method) {
        alert('Please fill in all transaction details with a valid amount greater than 0.');
        return;
    }
    
    transactions[editingTransactionIndex] = { type, method, date, amount };
    renderTransactions();
    updateTotals();
    closeEditModal();
    showNotification('Transaction updated successfully!');
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    editingTransactionIndex = -1;
}

window.onclick = function(event) {
    if (event.target == document.getElementById('editModal')) {
        closeEditModal();
    }
}

// Utility Functions
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });
}

function formatCurrency(number) {
    if (isNaN(number)) number = 0;
    return number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `<strong>${type === 'success' ? 'Success!' : 'Error!'}</strong> ${message}`;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// Preview and PDF Generation
function generatePreviewContent() {
    const invoiceData = {
        invNo: document.getElementById('invoiceNo').value || 'N/A',
        fullName: document.getElementById('fullName').value || 'N/A',
        address: document.getElementById('address').value || 'N/A',
        passport: document.getElementById('passport').value || 'N/A',
        contact: document.getElementById('contact').value || 'N/A',
        issuedDate: formatDate(document.getElementById('issuedDate').value) || 'N/A',
        dueDate: formatDate(document.getElementById('dueDate').value) || 'N/A',
        paymentMade: formatDate(document.getElementById('paymentMade').value) || 'Not Set',
        grandTotal: document.getElementById('grandTotal').textContent.replace(' LKR', ''),
    };

    let serviceRowsHTML = '';
    document.querySelectorAll('#servicesTableBody tr').forEach(row => {
        const desc = row.cells[0].querySelector('input').value;
        if (desc) {
            const qty = row.cells[1].querySelector('input').value;
            const price = formatCurrency(parseFloat(row.cells[2].querySelector('input').value) || 0);
            const total = row.cells[3].textContent;
            serviceRowsHTML += `<tr><td>${desc}</td><td>${qty}</td><td>${price}</td><td>${total}</td></tr>`;
        }
    });
    if (!serviceRowsHTML) serviceRowsHTML = `<tr><td colspan="4" style="text-align:center;">No services listed.</td></tr>`;

    let transactionRowsHTML = '';
    if (transactions.length > 0) {
        transactions.forEach(t => {
            const sign = t.type === 'Refund' ? '-' : '';
            const amountText = `${sign}${formatCurrency(t.amount)}`;
            transactionRowsHTML += `<tr><td>${formatDate(t.date)}</td><td>${t.type}</td><td>${t.method}</td><td style="color: ${t.type === 'Refund' ? '#dc2626' : '#059669'};">${amountText}</td></tr>`;
        });
    } else {
        transactionRowsHTML = `<tr><td colspan="4" style="text-align:center;">No transactions recorded.</td></tr>`;
    }
    
    const totalPaid = formatCurrency(transactions
        .filter(t => t.type === 'Payment')
        .reduce((sum, t) => sum + t.amount, 0));

    // *** NEW: Get the manually entered due amount from the first page for the preview ***
    const manualDueAmountValue = parseFloat(document.getElementById('dueAmountField').value) || 0;
    const formattedDueAmount = formatCurrency(manualDueAmountValue);

    const previewHTML = `
        <div class="pdf-invoice" id="printable-invoice-content">
            <div class="invoice-header">
                <div class="left">
                    <div class="company-info">
                        <h1>MANIKSHAN FOREIGN EMPLOYMENT</h1>
                        <div class="company-details">
                            <div class="contact-info">
                                <div class="contact-row"><span><strong>Tel (Sri Lanka):</strong> +94 77 586 4956</span></div>
                                <div class="contact-row"><span><strong>Tel (USA):</strong> +1 951-987-1313</span></div>
                                <div class="contact-row"><span><strong>Tel (Australia):</strong> +61 431 106 500</span></div>
                                <div class="contact-row"><span><strong>Email:</strong> info@manikshanforeignemployment.com</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="right">
                    <div class="invoice-title">
                        <h2>INVOICE</h2>
                        <div class="invoice-number">Invoice #: ${invoiceData.invNo}</div>
                    </div>
                </div>
            </div>
            <div class="billing-section">
                <div class="bill-to">
                    <div class="section-title">Bill To</div>
                    <div class="client-name">${invoiceData.fullName}</div>
                    <div class="client-details">
                        ${invoiceData.address.replace(/\n/g, '<br>')}<br>
                        <strong>Passport:</strong> ${invoiceData.passport} | <strong>Contact:</strong> ${invoiceData.contact}
                    </div>
                </div>
                <div class="invoice-dates">
                    <div class="section-title">Invoice Details</div>
                    <div class="client-details">
                        <strong>Issue Date:</strong> ${invoiceData.issuedDate}<br>
                        <strong>Due Date:</strong> ${invoiceData.dueDate}<br>
                        <strong>Payment Made:</strong> ${invoiceData.paymentMade}
                    </div>
                </div>
            </div>
            <div class="services-section">
                <div class="section-title">Services & Products</div>
                <table class="pdf-table">
                    <thead><tr><th>Description</th><th>Qty</th><th>Price (LKR)</th><th>Total (LKR)</th></tr></thead>
                    <tbody>${serviceRowsHTML}</tbody>
                </table>
            </div>
            <div class="totals-section">
                <table class="totals-table">
                    <tr><td>Subtotal:</td><td>${invoiceData.grandTotal} LKR</td></tr>
                    <tr><td>Total Paid:</td><td>${totalPaid} LKR</td></tr>
                    <tr class="total-due"><td>Amount Due:</td><td>${formattedDueAmount} LKR</td></tr>
                </table>
            </div>
            <div class="transactions-section">
                <div class="section-title">Payment History</div>
                <table class="pdf-table">
                    <thead><tr><th>Date</th><th>Type</th><th>Method</th><th>Amount (LKR)</th></tr></thead>
                    <tbody>${transactionRowsHTML}</tbody>
                </table>
            </div>
            <div class="footer-section">
                <div style="flex: 1;"><div style="font-size: 9pt; color: #666;"><strong>Payment Terms:</strong> Payment due within 30 days.<br><strong>Note:</strong> Late payments may incur charges.</div></div>
                <div class="thank-you">Thank you for<br>choosing our services!</div>
            </div>
        </div>
    `;
    
    document.getElementById('previewContent').innerHTML = previewHTML;
}

function generatePDF() {
    const previewContentWrapper = document.getElementById('previewContent');
    const pdfElement = previewContentWrapper.querySelector('.pdf-invoice');
    const downloadBtn = document.getElementById('downloadBtn');
    
    if (!pdfElement) {
        alert('Invoice content not found. Please generate the preview first.');
        return;
    }
    
    downloadBtn.innerHTML = 'Generating PDF...';
    downloadBtn.disabled = true;

    const originalStyle = { maxHeight: previewContentWrapper.style.maxHeight, overflowY: previewContentWrapper.style.overflowY };
    previewContentWrapper.style.maxHeight = 'none';
    previewContentWrapper.style.overflowY = 'visible';
    
    const contentHeightPx = pdfElement.offsetHeight;
    const A4_HEIGHT_PX = (297 / 25.4) * 96; 
    let requiredScale = (contentHeightPx > A4_HEIGHT_PX) ? A4_HEIGHT_PX / contentHeightPx : 1;

    const invoiceNumber = document.getElementById('invoiceNo').value || 'Invoice';
    const clientName = document.getElementById('fullName').value || 'Client';

    const opt = {
        margin: [5, 5, 5, 5], 
        filename: `${invoiceNumber}_${clientName.replace(/\s+/g, '_')}.pdf`,
        image: { type: 'jpeg', quality: 1.0 },
        html2canvas: { scale: 2 * requiredScale, useCORS: true, letterRendering: true, windowHeight: contentHeightPx, scrollY: 0 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: 'avoid-all' }
    };

    html2pdf().set(opt).from(pdfElement).save().then(() => {
        showNotification('PDF downloaded successfully!');
    }).catch(err => {
        console.error('PDF generation failed:', err);
        alert('Failed to generate PDF. Please try again.');
    }).finally(() => {
        previewContentWrapper.style.maxHeight = originalStyle.maxHeight;
        previewContentWrapper.style.overflowY = originalStyle.overflowY;
        downloadBtn.innerHTML = 'Download PDF Invoice';
        downloadBtn.disabled = false;
    });
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeEditModal();
});
</script>
</body>
</html>
